# Задача 2

```
написать API CRUD (добавление, чтение, обновление, удаление) для корзины. Использовать ядро d7
```

Так как новый роутер появился в Bitrix
с `21.400.0` (https://dev.1c-bitrix.ru/learning/course/index.php?COURSE_ID=43&CHAPTER_ID=013764), а на текущей установке
версия `21.400.100`, то будем делать роутинг на функционале битрикс.

У роутинга Bitrix есть ряд ограничений, так например существует только 3 (+ `group`) типа запроса:

- `get` - GET запрос;
- `post` - POST запрос;
- `any` - любой HTTP запрос.

Но так же есть полезные и уже реализованные функции:

- autowiring параметров методов-обработчиков запросов;
- возможность дополнять autowiring самому;
- набор предустановленных фильтров, которые применяются до и после запроса.

## Автозагрузка

Для автозагрузки нашего кода воспользуемя psr4 совместимым автозагрузчиков Bitrix:

```injectablephp
\Bitrix\Main\Loader::registerNamespace(
    'Local\\BasketCrud', 
    \Bitrix\Main\Loader::getDocumentRoot().'/local/src/BasketCrud'
);
```

## Настройка роутинга

В соответствие с документацией создадим файл `cart_crud.php` и разместим его по пути `/local/routes/cart_crud.php`.

В файле настроек битрикса (`.settings_extra.php`) укажем название файла с маршрутами:

```injectablephp
<?php

return [
    'routing' => [
        'value' => [
          'config' => ['basket_crud.php'],
        ],
    ], 
];
```

Так же пропишем базовый url для API в `.htaccess` в секции `<IfModule mod_rewrite.c>`:

```apacheconf
RewriteRule ^api/(.*) /bitrix/routing_index.php [L]
```

Данная настройка указывает что при всех url начинающихся с `/api/` будет подключаться новый Bitrix роутинг. Можно в
соответствие с документацией переключить весь роутинг на новый, но тогда нам будет необходимо переписать все пути к уже
готовым разделам сайта.

## Тестовые запросы

Примеры тестовых запросов в консоли. По умолчанию адрес сайта указан `127.0.0.1`.

Список товаров в корзине:

```shell
curl http://127.0.0.1/api/basket/
```

Добавление товара в корзину (данные товара для примера):

```shell
curl -d "id=123&quantity=2" http://127.0.0.1/api/basket/
# с количеством по умолчанию
curl -d "id=2" http://127.0.0.1/api/basket/
```

Просмотр информации о записи корзины с id `16`:

```shell
curl https://127.0.0.1/api/basket/16
```

Обновления товара (запись корзины с id `15`) в корзине (на примере количества):

```shell
curl -x POST -d "quantity=23" https://127.0.0.1/api/basket/15
```

Удаление товара с id `3` из корзины:

```shell
curl -x POST https://127.0.0.1/api/basket/delete/3
```
